
(function($){$.fn.jMyPuzzle=function(o){o=$.extend({answer:"7,2,1,3,8,5,6,4",maxTrials:3,classOnValid:'valid',classOnNotValid:'notValid',classOnMiValid:'miValid',fnOnCheck:null,ajaxResultUrl:'',fnOnAjax:null,fnOnReset:null,elts:new Array()},o||{});return this.each(function(){var div=$(this),ul=$("ul",div),li=$("li",ul);var left=0,move=null,forward=1,backward=2,eltPos=0;this.elts=new Array(li.size());var elts=this.elts,n=0,ulSize=0,nbTrials=0,nbValid=0,nbNotValid=0,nbMiValid=0;ul.css({display:'block',position:'absolute'});li.css({'float':'left',"list-style-type":"none",'display':'block','position':'absolute'});if(o.maxTrials>0&&$('#trials').length){$('#trials').html(0+'/'+o.maxTrials);}li.each(function(){ulSize+=width($(this));});ul.css({width:ulSize,height:((li.height()+parseInt(li.css('marginTop'))+parseInt(li.css('marginBottom'))+parseInt(li.css('paddingBottom'))*2+parseInt(li.css('paddingTop'))*2)+'px')});ul.css('left',div.offset().left+((div.width()-ulSize)/2));initPos();li.each(function(){var elt=$(this);elt.outerWidth=width($(this));elt.pos=getOffset(elt);elt.initialN=n;elt.n=n;elt.draggable({containment:div,drag:function(evt,ui){onDrag(evt,ui,elt,elts);},start:function(evt,ui){var e=elts[elt.n];e.css({'opacity':0.4,'z-index':200});},stop:function(evt,ui){var e=elts[elt.n];e.css({'opacity':1.0,'z-index':5});e.animate({left:e.pos.left,top:e.pos.top},300);}});elts[n++]=elt;});if($('#check').length){$('#check').click(function(){nbValid=0;nbNotValid=0;nbMiValid=0;if(o.maxTrials>0){if(nbTrials>=o.maxTrials){return;}nbTrials++;$('#trials').html(nbTrials+'/'+o.maxTrials);}var answerTab=o.answer.split(",");if(answerTab.length!=li.size()){alert("error - answer doesn't match !");}return check(0,answerTab);});}if($('#reset').length){$('#reset').click(function(){var nbElts=li.size();var eltN=0;for(i=0;i<nbElts;i++){if(elts[i].initialN!=i){for(j=i;j<nbElts;j++){if(elts[j].initialN==i){var wrongPiece=elts[i];elts[i]=elts[j];elts[i].n=i;elts[i].insertBefore(elts[i+1]);elts[j]=wrongPiece;elts[j].n=j;if(j+1<nbElts){elts[j].insertBefore(elts[j+1]);}else{elts[j].insertAfter(elts[j-1]);}break;}}}}initPos();for(i=0;i<nbElts;i++){elts[i].pos=getOffset(elts[i]);}o.fnOnReset();});}function check(n,answerTab){if(n>=answerTab.length){var nbWords=answerTab.length;var successPercent=((nbValid*1+nbMiValid*0.5)/nbWords)*100;var trialNb=nbTrials;var answer='';for(i=0;i<nbWords;i++){answer+=((elts[i].initialN+1)+",");}answer=answer.replace(/,+$/,"");jSonResults={nb_words:nbWords,nb_valid:nbValid,nb_not_valid:nbNotValid,nb_mi_valid:nbMiValid,success_rate:successPercent,trial_nb:trialNb,max_trials:o.maxTrials,answer:answer};if(o.fnOnCheck!==null){return o.fnOnCheck(jSonResults);}if(o.ajaxResultUrl!==''){$.post(o.ajaxResultUrl,jSonResults,function(data){if(o.fnOnAjax!==null){o.fnOnAjax(data);}});}return;}elts[n].removeClass(o.classOnValid+' '+o.classOnMiValid+' '+o.classOnNotValid);var posTop=parseInt(elts[n].pos.top);return elts[n].animate({'top':(posTop+7)+"px"},{duration:75,complete:function(){if(elts[n].initialN+1==answerTab[n]){elts[n].addClass(o.classOnValid);nbValid++;}else if(elts[n+2]&&o.answer.indexOf((elts[n].initialN+1)+','+(elts[n+1].initialN+1)+','+(elts[n+2].initialN+1))>=0){var j=0;for(j=0;j<answerTab.length;j++){if(elts[n].initialN+1==answerTab[j]){break;}}for(var i=0;i<answerTab.length;i++){if(elts[n+i]&&answerTab[i+j]==elts[n+i].initialN+1){if(i>0){elts[n+i].animate({'top':(posTop+7)+"px"},75).addClass(o.classOnMiValid).animate({'top':posTop+"px"},100);}else{elts[n+i].addClass(o.classOnMiValid);}nbMiValid++;}else{n+=(i-1);return;}}}else{elts[n].addClass(o.classOnNotValid);nbNotValid++;}}}).animate({'top':posTop+"px"},{duration:100,complete:function(){return check(n+1,answerTab);}});}function onDrag(e,ui,elt,elts){var oldPos=(this.eltPos!==null?this.eltPos:getOffset(elt));this.eltPos=getOffset(elt);if(this.eltPos.left==oldPos.left){return;}move=(this.eltPos.left>oldPos.left?forward:backward);if(move==forward){if(elt.n<elts.length-1){var eltNext=elts[elt.n+1];var eltNextBound=eltNext.pos.left+parseInt(eltNext.outerWidth/2);if(this.eltPos.left+elt.outerWidth>eltNextBound){elt.insertAfter(eltNext);eltNext.pos.left=elt.pos.left;elt.pos.left+=eltNext.outerWidth;elts[elt.n]=eltNext;elts[elt.n+1]=elt;elts[elt.n].n=elt.n;elt.n=elt.n+1;eltNext.animate({'left':eltNext.pos.left+'px'},300);}}}else if(move==backward){if(elt.n>0){var eltPrev=elts[elt.n-1];var eltPrevBound=eltPrev.pos.left+parseInt(eltPrev.outerWidth/2);if(this.eltPos.left<eltPrevBound){elt.insertBefore(eltPrev);elt.pos.left=eltPrev.pos.left;eltPrev.pos.left+=elt.outerWidth;elts[elt.n]=eltPrev;elts[elt.n-1]=elt;elts[elt.n].n=elt.n;elt.n=elt.n-1;eltPrev.animate({'left':eltPrev.pos.left+'px'},300);}}}}function getOffset(elt){return{left:parseInt(elt.css('left')),top:elt.css('top')=='auto'?0:parseInt(elt.css('top'))};}function initPos(){left=0;li.each(function(){$(this).css('left',left+'px');left+=width($(this));$(this).removeClass(o.classOnValid+' '+o.classOnMiValid+' '+o.classOnNotValid);$(this).addClass('normal');});}});};function css(el,prop){return parseInt($.css(el[0],prop))||0;}function width(el){return el[0].offsetWidth+css(el,'marginLeft')+css(el,'marginRight');}function debug(str){$('.debug').html($('.debug').html()+str+"<br/>");}})(jQuery);